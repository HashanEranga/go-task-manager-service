<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="009-add-users-manage-permission" author="system">
        <comment>Add users.manage permission for full user management access</comment>

        <!-- Add the users.manage permission -->
        <insert tableName="permissions">
            <column name="name" value="users.manage"/>
            <column name="resource" value="users"/>
            <column name="action" value="manage"/>
            <column name="description" value="Full user management access"/>
        </insert>
    </changeSet>

    <changeSet id="009-assign-users-manage-to-admin" author="system">
        <comment>Assign users.manage permission to ADMIN role</comment>

        <!-- Get the permission ID and assign to ADMIN role -->
        <sql>
            INSERT INTO role_permissions (role_id, permission_id)
            SELECT r.id, p.id
            FROM roles r, permissions p
            WHERE r.name = 'ADMIN' AND p.name = 'users.manage'
            AND NOT EXISTS (
                SELECT 1 FROM role_permissions rp
                WHERE rp.role_id = r.id AND rp.permission_id = p.id
            );
        </sql>

        <rollback>
            <sql>
                DELETE FROM role_permissions
                WHERE role_id = (SELECT id FROM roles WHERE name = 'ADMIN')
                AND permission_id = (SELECT id FROM permissions WHERE name = 'users.manage');
            </sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
